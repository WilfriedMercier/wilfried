<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <meta name="generator" content="sphinx-4.4.0, furo 2021.09.22"/>
        <title>galaxy.kinematics - wilfried library 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=150e365fa939648e89c22f6d7d13c72a1657915a" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=16fb25fabf47304eee183a5e9af80b1ba98259b1" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: red;
  --color-brand-content: #CC3333;
  --color-admonition-background: orange;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: red;
  --color-brand-content: #CC3333;
  --color-content-foreground: #ababab;
  --color-api-overall: white;
  --color-sidebar-brand-text: red;
  --color-sidebar-item-background--current: #CC3333;
  --color-sidebar-link-text: white;
  --color-sidebar-link-text--top-level: white;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: red;
  --color-brand-content: #CC3333;
  --color-content-foreground: #ababab;
  --color-api-overall: white;
  --color-sidebar-brand-text: red;
  --color-sidebar-item-background--current: #CC3333;
  --color-sidebar-link-text: white;
  --color-sidebar-link-text--top-level: white;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">wilfried library 1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">wilfried library 1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../dependencies.html">Required dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../makeLifeSimpler.html">makeLifeSimpler</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../utilities/index.html">Useful utilities</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../utilities/coloredMessages.html">Colored messages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../utilities/dict.html">Dictionaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../utilities/io.html">Input/Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../utilities/list.html">List manipulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../utilities/strings.html">Strings manipulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../utilities/misc.html">Miscellaneous</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../utilities/plotUtilities/index.html">Plot utilities</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../utilities/plotUtilities/asManyHists.html">Histograms</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../utilities/plotUtilities/hst.html">Galfit related plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../utilities/plotUtilities/misc.html">Miscellaneous</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../utilities/plotUtilities/singleContour.html">Contours</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../galaxy/index.html">Galaxy module</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../galaxy/angularMomentum.html">Galaxies angular momentum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../galaxy/cosmology.html">Cosmology computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../galaxy/geometry.html">Galaxies angular momentum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../galaxy/kinematics.html">Galaxy kinematics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../galaxy/misc.html">Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../galaxy/massModels.html">Galaxy mass models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../galaxy/models.html">Galaxy models</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../galaxy/morphology/index.html">Galaxies morphology</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../galaxy/morphology/SersicFlux.html">Sersic fluxes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../galaxy/morphology/Morpho.html">Morphological parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../galaxy/morphology/Thickness.html">Galaxies thickness</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../galaxy/morphology/MUSE.html">MUSE related functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../galaxy/morphology/Other.html">Other Sersic related functions</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../galaxy/photometry/index.html">Galaxies photometry</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../galaxy/photometry/Fluxes.html">Fluxes, colour excess and attenuation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../galaxy/photometry/Masses_SFR.html">Masses and SFR estimates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../galaxy/photometry/Magnitudes.html">Magnitude conversions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../galfit/index.html">Galfit module</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../galfit/galfit.html">Galfit auto-routines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../galfit/models.html">Galfit models</a></li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for galaxy.kinematics</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""</span>
<span class="sd">.. codeauthor:: Epinat Benoit - LAM &lt;benoit.epinat@lam.fr&gt; &amp; Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>

<span class="sd">Fonctions related to kinematical modelling of galaxies.</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span>                     <span class="k">as</span>     <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.io.ascii</span>          <span class="k">as</span>     <span class="nn">asci</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span>           <span class="k">as</span>     <span class="nn">fits</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span>         <span class="k">as</span>     <span class="nn">ct</span>
<span class="kn">from</span>   <span class="nn">astropy.units</span>             <span class="kn">import</span> <span class="n">Quantity</span>
<span class="kn">from</span>   <span class="nn">numpy</span>                     <span class="kn">import</span> <span class="n">ndarray</span>
<span class="kn">from</span>   <span class="nn">.symlinks.coloredMessages</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span>   <span class="nn">.MUSE</span>                     <span class="kn">import</span> <span class="n">compute_lsfw</span>
<span class="kn">from</span>   <span class="nn">typing</span>                    <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1">##########################################################################################################</span>
<span class="c1">#                                         Kinematical properties                                         #</span>
<span class="c1">##########################################################################################################</span>

<div class="viewcode-block" id="velocityAtR"><a class="viewcode-back" href="../../galaxy/kinematics.html#galaxy.kinematics.velocityAtR">[docs]</a><span class="k">def</span> <span class="nf">velocityAtR</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">Vt</span><span class="p">,</span> <span class="n">Rt</span><span class="p">,</span> <span class="n">Rlast</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">'''</span>
<span class="sd">    .. codeauthor:: Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    Assuming a linear ramp model, try to compute the velocity at a single radius</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        V(R) = V_t \times R/r_t \ \ \rm{if}\ \ R \leq r_t \ \ \rm{else} \ \ V_t.</span>

<span class="sd">    :param radius: position where the velocity must be computed (in the same units as Rt and Rlast)</span>
<span class="sd">    :type radius: int or float</span>
<span class="sd">    :param float Vt: plateau velocity</span>
<span class="sd">    :param float Rt: radius of transition between the inner linear slope and the outer plateau</span>
<span class="sd">    :param float Rlast: distance from the centre of the furthest pixel used in the fit</span>
<span class="sd">    </span>
<span class="sd">    :param bool verbose: (**Optional**) whether print error messages or not</span>
<span class="sd">    </span>
<span class="sd">    :returns: the computed velocity in units of Vt and a boolean value indicating whether the computed value is reliable or not</span>
<span class="sd">    :rtype: int or float and bool</span>
<span class="sd">    '''</span>

    <span class="c1"># If Rt&lt;Rlast or (Rt&gt;Rlast and radius&lt;Rlast), there is no issue, but when Rt&gt;Rlast, the value is much more unconstrained</span>
    <span class="k">if</span> <span class="n">Rt</span> <span class="o">&lt;=</span> <span class="n">Rlast</span> <span class="ow">or</span> <span class="n">radius</span> <span class="o">&lt;=</span> <span class="n">Rlast</span><span class="p">:</span>
        <span class="n">ok</span>           <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="n">Rt</span><span class="p">:</span>
            <span class="n">velocity</span> <span class="o">=</span> <span class="n">radius</span><span class="o">/</span><span class="n">Rt</span><span class="o">*</span><span class="n">Vt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">velocity</span> <span class="o">=</span> <span class="n">Vt</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">errorMessage</span><span class="p">(</span><span class="s1">'Rt &gt; Rlast by </span><span class="si">%.1f</span><span class="s1">'</span> <span class="o">%</span><span class="p">(</span><span class="n">Rt</span><span class="o">-</span><span class="n">Rlast</span><span class="p">)))</span>
        <span class="n">ok</span>           <span class="o">=</span> <span class="kc">False</span>
        <span class="n">velocity</span>     <span class="o">=</span> <span class="n">radius</span><span class="o">/</span><span class="n">Rt</span><span class="o">*</span><span class="n">Vt</span>
        
    <span class="k">return</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">ok</span></div>

<span class="c1">####################################################################################################################</span>
<span class="c1">#                                                Analysis part                                                     #</span>
<span class="c1">####################################################################################################################</span>

<div class="viewcode-block" id="apply_mask"><a class="viewcode-back" href="../../galaxy/kinematics.html#galaxy.kinematics.apply_mask">[docs]</a><span class="k">def</span> <span class="nf">apply_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    .. codeauthor:: Epinat Benoit - LAM &lt;benoit.epinat@lam.fr&gt; &amp; Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    This function applies a mask to an image and puts nan in the masked area.</span>

<span class="sd">    :param ndarray mask: array containing the indices of the pixels to be masked</span>
<span class="sd">    :param ndarray image: image to be masked</span>
<span class="sd">    </span>
<span class="sd">    :returns: the masked image</span>
<span class="sd">    :rtype: ndarray</span>
<span class="sd">    '''</span>
    
    <span class="n">newImage</span>       <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">newImage</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">newImage</span></div>


<div class="viewcode-block" id="clean_galaxy"><a class="viewcode-back" href="../../galaxy/kinematics.html#galaxy.kinematics.clean_galaxy">[docs]</a><span class="k">def</span> <span class="nf">clean_galaxy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">outputpath</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lsfw</span><span class="p">,</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_mask</span><span class="o">=</span><span class="s1">'snr'</span><span class="p">,</span> <span class="n">thrl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thru</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">'_ssmooth'</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">'_OII3729'</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    .. codeauthor:: Epinat Benoit - LAM &lt;benoit.epinat@lam.fr&gt; &amp; Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    This function cleans the maps created by CAMEL for a given galaxy.</span>

<span class="sd">    :param float fraction: fraction for a lower threshold on the velocity dispersion map</span>
<span class="sd">    :param float lsfw: spectral resolution in *km/s* (sigma)</span>
<span class="sd">    :param str name: name of the galaxy</span>
<span class="sd">    :param str ouputpath: path where the ouput data will be stored</span>
<span class="sd">    :param str path: path where the input data are stored</span>

<span class="sd">    :param str clean: (**Optional**) name of the manually cleaned map. If None, no cleaned map is used to add an additional mask.</span>
<span class="sd">    :param data_mask: (**Optional**) basename of the map used for the threshold (e.g. 'snr' to use the signal to noise ratio map)</span>
<span class="sd">    :type data_mask: str or list[str]</span>
<span class="sd">    :param str line: (**Optional**)  line used (suffixe, e.g. '_Ha')</span>
<span class="sd">    :param str option: (**Optional**) option of CAMEL to find the files to clean (e.g. '_ssmooth')</span>
<span class="sd">    :param thrl: (**Optional**)  lower threshold for cleaning. Is None, the minimum (apart from nan) will be used.</span>
<span class="sd">    :type thrl: float or list[float]</span>
<span class="sd">    :param thru: (**Optional**)  upper threshold for cleaning. Is None, the maximum (apart from nan) will be used.</span>
<span class="sd">    :type thru: float or list[float]</span>
<span class="sd">    </span>
<span class="sd">    :returns: None</span>
<span class="sd">    '''</span>
    
    <span class="c1">#Checking path exists</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: path </span><span class="si">% s</span><span class="s1"> does not exist'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
        <span class="n">answer</span>      <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'Should we skip this galaxy ? [Y or N] '</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'y'</span><span class="p">,</span> <span class="s1">'yes'</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">()</span>
 
    <span class="c1">#Checking output path exists</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outputpath</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: path </span><span class="si">% s</span><span class="s1"> does not exist'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">outputpath</span><span class="p">)))</span>
        <span class="n">answer</span>      <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'Should we skip this galaxy ? [Y or N] '</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'y'</span><span class="p">,</span> <span class="s1">'yes'</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">()</span>
    
    <span class="c1"># Dispersion threshold</span>
    <span class="n">smin</span>            <span class="o">=</span> <span class="n">lsfw</span> <span class="o">*</span> <span class="n">fraction</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: dispersion threshold </span><span class="si">% s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">smin</span><span class="p">)))</span>
    
    <span class="c1"># Correct path name if wrongly provided</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'/'</span><span class="p">:</span>
        <span class="n">path</span>       <span class="o">+=</span> <span class="s1">'/'</span>
        
    <span class="k">if</span> <span class="n">outputpath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'/'</span><span class="p">:</span>
        <span class="n">outputpath</span> <span class="o">+=</span> <span class="s1">'/'</span>
        
    <span class="c1"># Set data_mask to a list if it is only a string</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_mask</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">data_mask</span>   <span class="o">=</span> <span class="p">[</span><span class="n">data_mask</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thrl</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">thrl</span>        <span class="o">=</span> <span class="p">[</span><span class="n">thrl</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thru</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">thru</span>        <span class="o">=</span> <span class="p">[</span><span class="n">thru</span><span class="p">]</span>
    
    <span class="c1"># Get file in path with given name and option + dispersion map + map used for the mask (generally snr)</span>
    <span class="n">files</span>           <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">option</span> <span class="o">+</span> <span class="s1">'*.fits'</span><span class="p">)</span>
    <span class="n">fim0</span>            <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">option</span> <span class="o">+</span> <span class="s1">'_disp_*[pn].fits'</span><span class="p">)</span>
    <span class="n">fim1</span>            <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name_mask</span> <span class="ow">in</span> <span class="n">data_mask</span><span class="p">:</span>
        <span class="n">fim1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">option</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="n">name_mask</span> <span class="o">+</span> <span class="s1">'_*[pn].fits'</span><span class="p">))</span>
    
    <span class="c1"># Try to open the dispersion file (first extension)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fim0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">hdul0</span><span class="p">:</span>
            <span class="n">im0</span>     <span class="o">=</span> <span class="n">hdul0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: using </span><span class="si">% s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fim0</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: </span><span class="si">% s</span><span class="s1"> not found'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">option</span> <span class="o">+</span> <span class="s1">'_disp_*[pn].fits'</span><span class="p">)))</span>
        <span class="n">answer</span>      <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'Should we skip this galaxy ? [Y or N] '</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'y'</span><span class="p">,</span> <span class="s1">'yes'</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">()</span>
        
    <span class="c1"># Try to open the map used for the mask (first extension for each map in fim1 list)</span>
    <span class="n">im1</span>             <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fi1</span><span class="p">,</span> <span class="n">name_mask</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fim1</span><span class="p">,</span> <span class="n">data_mask</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fi1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">hdul1</span><span class="p">:</span>
                <span class="n">im1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdul1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: using </span><span class="si">% s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fi1</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: </span><span class="si">% s</span><span class="s1"> not found'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">option</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="n">name_mask</span> <span class="o">+</span> <span class="s1">'_*[pn].fits'</span><span class="p">)))</span>
            <span class="n">answer</span>  <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'Should we skip this galaxy ? [Y or N] '</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'y'</span><span class="p">,</span> <span class="s1">'yes'</span><span class="p">]:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">()</span>
    
    <span class="c1">##################################################################</span>
    <span class="c1">#                         Creating masks                         #</span>
    <span class="c1">##################################################################</span>
    
    <span class="c1"># Dispersion mask: True where im0&gt;=smin</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: making dispersion mask'</span><span class="p">)</span>
    <span class="n">mask0</span>     <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="n">im0</span><span class="p">,</span> <span class="n">thrl</span><span class="o">=</span><span class="n">smin</span><span class="p">)</span>
    
    <span class="c1"># Provided masks: True where thrl&lt;=im1&lt;=thru</span>
    <span class="n">mask1</span>     <span class="o">=</span> <span class="n">mask0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="kc">False</span> <span class="o">+</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">tl</span><span class="p">,</span> <span class="n">tu</span><span class="p">,</span> <span class="n">name_mask</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">thrl</span><span class="p">,</span> <span class="n">thru</span><span class="p">,</span> <span class="n">data_mask</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: making an additional mask (</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span><span class="n">name_mask</span><span class="p">)</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">create_mask</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">thrl</span><span class="o">=</span><span class="n">tl</span><span class="p">,</span> <span class="n">thru</span><span class="o">=</span><span class="n">tu</span><span class="p">))</span>
    
    <span class="c1"># Keep positions where the values are out of bounds</span>
    <span class="n">mask</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask0</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask1</span><span class="p">)))</span>
    
    <span class="c1">##############################################################</span>
    <span class="c1">#               Using the manually cleaned map               #</span>
    <span class="c1">##############################################################</span>
    
    <span class="k">if</span> <span class="n">clean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fcl</span>          <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">clean</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get data and generate a mask wherever data is not None (neither upper nor lower threshold applied)</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fcl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">hducl</span><span class="p">:</span>
                <span class="n">imcl</span> <span class="o">=</span> <span class="n">hducl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                
            <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: using </span><span class="si">% s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fcl</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">)</span>    
            <span class="n">maskcl</span>   <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span><span class="n">imcl</span><span class="p">,</span> <span class="n">thrl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thru</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">mask2</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask0</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask1</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">maskcl</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'clean_galaxy: </span><span class="si">% s</span><span class="s1"> not found'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">clean</span><span class="p">))</span> <span class="p">)</span>
            <span class="n">clean</span>    <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1">#################################################</span>
    <span class="c1">#             Updating all the maps             #</span>
    <span class="c1">#################################################</span>
    
    <span class="k">for</span> <span class="n">fim</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        
        <span class="c1"># We skip files which are already cleaned (either manually or automatically). This assumes that cleaned files have a 'clean' keyword in their name</span>
        <span class="k">if</span> <span class="s1">'clean'</span> <span class="ow">in</span> <span class="n">fim</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fim</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
            <span class="n">im</span>           <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            
        <span class="c1"># We skip datacubes</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Setting up the threshold value that will appear in the output file name</span>
        <span class="n">thr</span>              <span class="o">=</span> <span class="mi">0</span>
        <span class="n">notNonethrl</span>      <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">thrl</span><span class="p">))</span>
        <span class="n">notNonethru</span>      <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">thru</span><span class="p">))</span>
        <span class="k">if</span>  <span class="nb">len</span><span class="p">(</span><span class="n">notNonethrl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">thr</span>          <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">notNonethrl</span><span class="p">)</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">notNonethru</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">thr</span>          <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">notNonethru</span><span class="p">)</span>

        <span class="c1"># Directly modify the file data by applying the master mask (velocity dispersion + any other mask used such as snr)</span>
        <span class="k">if</span> <span class="n">clean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">apply_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
            <span class="n">fimcl</span>        <span class="o">=</span> <span class="n">fim</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.fits'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'_clean</span><span class="si">%3.1f</span><span class="s1">.fits'</span> <span class="o">%</span><span class="n">thr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">apply_mask</span><span class="p">(</span><span class="n">mask2</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
            <span class="n">fimcl</span>        <span class="o">=</span> <span class="n">fim</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.fits'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'_mclean</span><span class="si">%3.1f</span><span class="s1">.fits'</span> <span class="o">%</span><span class="n">thr</span>
            
        <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outputpath</span> <span class="o">+</span> <span class="n">fimcl</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'output written in </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span><span class="p">(</span><span class="n">outputpath</span><span class="o">+</span><span class="n">fimcl</span><span class="p">))</span>
    
    <span class="k">return</span></div>


<div class="viewcode-block" id="clean_setofgalaxies"><a class="viewcode-back" href="../../galaxy/kinematics.html#galaxy.kinematics.clean_setofgalaxies">[docs]</a><span class="k">def</span> <span class="nf">clean_setofgalaxies</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">'galsList.input'</span><span class="p">,</span> <span class="n">logFile</span><span class="o">=</span><span class="s1">'folderList.list'</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">data_mask</span><span class="o">=</span><span class="s1">'snr'</span><span class="p">,</span> <span class="n">thrl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thru</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">'_ssmooth'</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">'_OII3729'</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    .. codeauthor:: Epinat Benoit - LAM &lt;benoit.epinat@lam.fr&gt; &amp; Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    Clean maps created by camel for a list of galaxies.</span>
<span class="sd">        </span>
<span class="sd">    .. note::</span>
<span class="sd">        **How to use**</span>
<span class="sd">        </span>
<span class="sd">        Provide:</span>
<span class="sd">            - a filename containing two columns: the absolute file name of every galaxy config file (thus ending with .config) and their corresponding spectral resolution in km/s (e.g. /home/wilfried/CGr114_s/o2/CGr114_101_o2.config 30).</span>
<span class="sd">            - a keyword for the additional mask (apart from the spectral width criterion), or a list of keywords</span>
<span class="sd">            - thresholds if necessary</span>
<span class="sd">            - a clean map if there is one. The same name will be used for every galaxy. Best practice would be to use an identical name for all the galaxies (located in different folders), such as 'clean.fits'.</span>
<span class="sd">    </span>
<span class="sd">    :param str filename: name of the input file containing two columns: the list of galaxies and the associated spectral resolution in *km/s* (sigma)</span>
<span class="sd">    :param str path: path where the input file is stored</span>
<span class="sd">    :param str logFile: name of of the file containing the list of the output folder names</span>
<span class="sd">            </span>
<span class="sd">    :param str clean: (**Optional**) name of the manually cleaned map.If None, no clean file is used to add an another manual mask.</span>
<span class="sd">    :param data_mask: (**Optional**) basename of the map used for threshold (e.g. 'snr' for signal to noise ratio map)</span>
<span class="sd">    :type data_mask: str or list[str]</span>
<span class="sd">    :param float fraction: (**Optional**) fraction for a lower threshold on the velocity dispersion map</span>
<span class="sd">    :param float thrl: (**Optional**) lower threshold for cleaning. Is None, the minimum (apart from nan) will be used.</span>
<span class="sd">    :param float thru: (**Optional**) upper threshold for cleaning. If None, the maximum (apart from nan) will be used.</span>
<span class="sd">    :param str option: (**Optional**) option from camel to find the files to clean (e.g. '_ssmooth')</span>
<span class="sd">    :param str line: (**Optional**) line used (suffixe, e.g. '_Ha')</span>
<span class="sd">    </span>
<span class="sd">    :returns: None</span>
<span class="sd">    '''</span>
    
    <span class="c1"># If the user provides o2 as line we change it to the correct value</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">'o2'</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">'_OII3729'</span>
    
    <span class="n">cat</span>                     <span class="o">=</span> <span class="n">asci</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="c1"># Generating a new name if the given file name already exsits</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">logFile</span><span class="p">):</span>
        <span class="n">splt</span>                <span class="o">=</span> <span class="n">logFile</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="s1">'.'</span> <span class="o">+</span> <span class="n">splt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num</span>             <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">splt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">splt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>         <span class="o">=</span> <span class="n">splt</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">num</span>             <span class="o">=</span> <span class="mi">1</span>
        <span class="n">logFile</span>             <span class="o">=</span> <span class="n">splt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="n">end</span>
        
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logFile</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">:</span>
            <span class="c1"># Get name without the extension at the end and path</span>
            <span class="n">name</span>            <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.config'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">galPath</span>         <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">'.config'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">clean_galaxy</span><span class="p">(</span><span class="n">galPath</span><span class="p">,</span> <span class="n">galPath</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">data_mask</span><span class="o">=</span><span class="n">data_mask</span><span class="p">,</span> <span class="n">thru</span><span class="o">=</span><span class="n">thru</span><span class="p">,</span> <span class="n">thrl</span><span class="o">=</span><span class="n">thrl</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="n">clean</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">galPath</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="correct_redshift"><a class="viewcode-back" href="../../galaxy/kinematics.html#galaxy.kinematics.correct_redshift">[docs]</a><span class="k">def</span> <span class="nf">correct_redshift</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">],</span> <span class="n">Vsys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">]:</span>
    <span class="sa">r</span><span class="sd">'''</span>
<span class="sd">    Correct the given redshifts using the systemic velocity due to the galaxies proper motion.</span>
<span class="sd">    </span>
<span class="sd">    :param z: cosmological redshift</span>
<span class="sd">    :type z: float or ndarray</span>
<span class="sd">    :param Vsys: systemic velocity in km/s if not an Astropy Quantity</span>
<span class="sd">    :type Vsys: float, ndarray or Astropy Quantity</span>
<span class="sd">    </span>
<span class="sd">    :returns: corrected redshifts</span>
<span class="sd">    :rtype: float or ndarray</span>
<span class="sd">    '''</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Vsys</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">):</span>
        <span class="n">Vsys</span> <span class="o">=</span> <span class="n">Vsys</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">'km/s'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Vsys</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">Vsys</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'km/s'</span><span class="p">)</span>
        
    <span class="n">z_sys</span>    <span class="o">=</span> <span class="p">(</span><span class="n">Vsys</span> <span class="o">/</span> <span class="n">ct</span><span class="o">.</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z_sys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="compute_velres"><a class="viewcode-back" href="../../galaxy/kinematics.html#galaxy.kinematics.compute_velres">[docs]</a><span class="k">def</span> <span class="nf">compute_velres</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lbda0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                   <span class="n">a2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.835e-8</span><span class="p">,</span> <span class="n">a1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.080e-4</span><span class="p">,</span> <span class="n">a0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.983</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="sa">r</span><span class="sd">'''</span>
<span class="sd">    .. codeauthor:: Epinat Benoit - LAM &lt;benoit.epinat@lam.fr&gt;</span>
<span class="sd">    </span>
<span class="sd">    Compute the spectral resolution in terms of velocity sigma from the line restframe wavelength, the redshift of the source and from MUSE LSF model</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        {\rm{FWHM}}(\lambda) = a2 \times \lambda^2 + a1 \times \lambda + a0</span>

<span class="sd">    :param float lbda0: rest frame wavelength of the line used to infer kinematics in **Angstroms**</span>
<span class="sd">    :param float z: redshift of the galaxy</span>

<span class="sd">    :param float a0: (**Optional**) lambda ** 0 coefficient of the variation of LSF FWHM with respect to lambda</span>
<span class="sd">    :param float a1: (**Optional**) lambda ** 1 coefficient of the variation of LSF FWHM with respect to lambda</span>
<span class="sd">    :param float a2: (**Optional**) lambda ** 2 coefficient of the variation of LSF FWHM with respect to lambda</span>
<span class="sd">    </span>
<span class="sd">    :returns: the observed (redshifted) wavelength, the LSF FWHM in **Angstroms** and the LSF dispersion in **km/s**, assuming a Gaussian shape for the LSF profile.</span>
<span class="sd">    :rtype: float, float and float</span>
<span class="sd">    '''</span>
    
    <span class="n">lbda</span>   <span class="o">=</span> <span class="n">lbda0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">fwhm</span>   <span class="o">=</span> <span class="n">compute_lsfw</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lbda0</span><span class="p">,</span> <span class="n">a2</span><span class="o">=</span><span class="mf">5.835e-8</span><span class="p">,</span> <span class="n">a1</span><span class="o">=-</span><span class="mf">9.080e-4</span><span class="p">,</span> <span class="n">a0</span><span class="o">=</span><span class="mf">5.983</span><span class="p">)</span>
    <span class="n">velsig</span> <span class="o">=</span> <span class="n">fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="n">lbda</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">ct</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="mf">1e-3</span>
    <span class="k">return</span> <span class="n">lbda</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">velsig</span></div>


<div class="viewcode-block" id="velres_setofgalaxies"><a class="viewcode-back" href="../../galaxy/kinematics.html#galaxy.kinematics.velres_setofgalaxies">[docs]</a><span class="k">def</span> <span class="nf">velres_setofgalaxies</span><span class="p">(</span><span class="n">inname</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">lbda0</span><span class="p">,</span> <span class="n">a2</span><span class="o">=</span><span class="mf">5.835e-8</span><span class="p">,</span> <span class="n">a1</span><span class="o">=-</span><span class="mf">9.080e-4</span><span class="p">,</span> <span class="n">a0</span><span class="o">=</span><span class="mf">5.983</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    .. codeauthor:: Epinat Benoit - LAM &lt;benoit.epinat@lam.fr&gt; &amp; Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    Compute the resolution in velocity for a list of galaxies and write it into an output file along the corresponding file name.</span>
<span class="sd">        </span>
<span class="sd">    .. note::</span>
<span class="sd">        </span>
<span class="sd">        **How to use**</span>
<span class="sd">        </span>
<span class="sd">        Provide an input and output file names and the line rest-frame wavelength in Angstroms. The input file shoudl contain the following columns:</span>
<span class="sd">            - galaxy file names</span>
<span class="sd">            - redshift of the galaxies</span>

<span class="sd">    :param str inname: input file name containing the list of galaxies and their redshift. In this version, the redshift is in the name itself, as well as the line used.</span>
<span class="sd">    :param str outname: output file name containing the list of galaxies and the spectral resolution</span>

<span class="sd">    :param float a0: (**Optional**) lambda ** 0 coefficient of the variation of LSF FWHM with respect to lambda</span>
<span class="sd">    :param float a1: (**Optional**) lambda ** 1 coefficient of the variation of LSF FWHM with respect to lambda</span>
<span class="sd">    :param float a2: (**Optional**) lambda ** 2 coefficient of the variation of LSF FWHM with respect to lambda</span>
<span class="sd">    </span>
<span class="sd">    :returns: None</span>
<span class="sd">    '''</span>
    
    <span class="n">cat</span>                        <span class="o">=</span> <span class="n">asci</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">inname</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">:</span>
            <span class="n">z</span>                  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">lbda</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">velsig</span> <span class="o">=</span> <span class="n">compute_velres</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">lbda0</span><span class="p">,</span> <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="p">,</span> <span class="n">a0</span><span class="o">=</span><span class="n">a0</span><span class="p">)</span>
            <span class="n">line</span>               <span class="o">=</span> <span class="s1">'</span><span class="si">{0:100}</span><span class="s1"> </span><span class="si">{1:5.1f}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">velsig</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="create_mask"><a class="viewcode-back" href="../../galaxy/kinematics.html#galaxy.kinematics.create_mask">[docs]</a><span class="k">def</span> <span class="nf">create_mask</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">thrl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thru</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    .. codeauthor:: Epinat Benoit - LAM &lt;benoit.epinat@lam.fr&gt; &amp; Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    This function creates a mask from an image using a lower and an upper threshold.</span>

<span class="sd">    :param ndarray image: image used to create the mask</span>
<span class="sd">    </span>
<span class="sd">    :param float thrl: (**Optional**) lower threshold</span>
<span class="sd">    :param float thru: (**Optional**) upper threshold</span>
<span class="sd">    </span>
<span class="sd">    :returns: boolean mask (True everywhere thrl&lt;=image&lt;=thru)</span>
<span class="sd">    :rtype: ndarray(bool)</span>
<span class="sd">    '''</span>
    
    <span class="k">if</span> <span class="n">thrl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">thru</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thru</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">It seems that no maximum value can be found. Please check that your .fits file is not corrupted.</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
            
    <span class="nb">print</span><span class="p">(</span><span class="s1">'create_mask: lower threshold </span><span class="si">% s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">thrl</span><span class="p">))</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'create_mask: upper threshold </span><span class="si">% s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">thru</span><span class="p">))</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="p">((</span><span class="n">image</span> <span class="o">&lt;=</span> <span class="n">thru</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">image</span> <span class="o">&gt;=</span> <span class="n">thrl</span><span class="p">))</span></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>

        <div class="related-information">
              Copyright &#169; 2022, Wilfried Mercier |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/main.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    </body>
</html>